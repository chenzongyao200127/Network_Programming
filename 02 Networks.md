# Networks
# 网络扫盲

客户端和服务器通常运行在不同的主机上，并且通过计算机网络的硬件和软件资源来通信。
网络是很复杂的系统，在这里我们只想了解一点皮毛。我们的目标是从程序员的角度给你一个切实可行的思维模型。

对主机而言，网络只是又一种 I/O 设备，是数据源和数据接收方，如图 11-2 所示。

一个插到 I/O 总线扩展槽的适配器提供了到网络的物理接口。从网络上接收到的数据从适配器经过 `I/O` 和`内存总线`复制到内存，通常是通过 *DMA* 传送。
相似地，数据也能从内存复制到网络。

物理上而言，网络是一个按照地理远近组成的层次系统。最低层是 LAN（Local Area Network，局域网），在一个建筑或者校园范围内。
迄今为止，最流行的局域网技术是以太网（*Ethernet*），它是由施乐公司帕洛阿尔托研究中心（Xerox PARC）在 20 世纪 70 年代中期提出的。以太网技术被证明是适应力极强的，从 3 Mb/s 演变到 10 Gb/s。

====================================================================================================
# Ethernet

Ethernet is a family of networking technologies commonly used in local area networks (LAN), metropolitan area networks (MAN), and wide area networks (WAN). It was first introduced in the 1970s by Xerox PARC and has since become the most widely used method of networking computers together. Here are some key aspects of Ethernet:

### Basic Characteristics

1. **Physical and Data Link Layers**: 
   - Ethernet operates primarily at the `physical` layer and the `data link` layer of the OSI model. The physical layer deals with the physical connection between devices, while the data link layer handles the communication between network interfaces at the hardware level.

2. **Frames**:
   - Data in Ethernet networks is transmitted in packets known as frames. Each `frame` contains source and destination addresses, along with error-checking and control information.

3. **Standardized Speeds**:
   - Over the years, Ethernet technology has evolved to support faster speeds. The original Ethernet supported speeds of up to 10 Mbps (megabits per second). Current standards now support 1 Gbps (gigabit per second), 10 Gbps, and even higher speeds like 40 Gbps and 100 Gbps in some cases.

4. **Cabling**:
   - Ethernet networks typically use `twisted pair cables` (like Cat5, Cat6) or `fiber optic cables` for connection. The choice of cable affects the speed and distance over which the data can be transmitted.

### Working Mechanism

1. **CSMA/CD (Carrier Sense Multiple Access with Collision Detection)**:
   - In traditional Ethernet, `CSMA/CD` is used for controlling access to the network medium. A device checks to see if the line is free before transmitting and if a collision is detected (two devices transmit simultaneously), it stops and waits a random amount of time before trying again.

2. **Switched Ethernet**:
   - Modern Ethernet networks use switches, which create a virtual direct connection between two devices. This has largely eliminated the need for CSMA/CD as collisions are now rare.

3. **MAC Addresses**:
   - Each Ethernet network interface has a unique MAC (Media Access Control) address used to identify devices on the network. Frames are sent to specific MAC addresses.

### Applications

- **LAN Connectivity**: Ethernet is most commonly used for connecting devices in a LAN, such as in home or office networks.
- **Internet Access**: Ethernet is also used for connecting to the Internet through modems and routers.
- **Data Centers and Enterprises**: For large networks, Ethernet provides the backbone for data transmission and connectivity.

Ethernet has continued to evolve, with newer standards offering improvements in speed, latency, and power consumption. Its widespread adoption is due in part to its simplicity, reliability, and ability to adapt to the growing demands of modern network environments.

### CSMA/CD（载波侦听多路访问/冲突检测）

1. **载波侦听（Carrier Sense）**:
   - 在以太网中，每个设备在发送数据之前必须先检查网络线路（即共享媒介）是否空闲。这个过程称为载波侦听。如果线路空闲，设备开始发送数据。
2. **多路访问（Multiple Access）**:
   - “多路访问”意味着网络上的多个设备可以使用同一网络媒介进行通信。但这也意味着有可能出现两个或更多设备同时尝试发送数据的情况，从而导致冲突。
3. **冲突检测（Collision Detection）**:
   - 如果两个设备几乎同时开始发送数据，它们的信号在网络中相遇并发生冲突。以太网设备能够检测到这种冲突，一旦检测到冲突，它们会立即停止发送数据。
   - 每个设备在尝试重新发送数据之前都会等待一个随机的时间长度，这个机制被称为“退避算法”。这样做是为了减少重新发生冲突的概率。
4. **重新传输**:
   - 在等待了随机的时间长度后，设备再次检查网络线路是否空闲，然后尝试重新发送数据。如果再次发生冲突，它们将重复这个过程，直到成功发送数据。

### 交换式以太网

随着技术的发展，传统的CSMA/CD机制在现代以太网中的作用已大大减少。这主要是因为引入了网络交换机：
1. **交换机（Switches）**:
   - 网络交换机使每个连接到它的设备都有一个单独的网络段。这意味着每个设备都直接与交换机通信，而不是像早期的以太网那样共享一个通信媒介。
2. **冲突域的消除**:
   - 由于每个设备都有其独立的通信通道，因此几乎消除了冲突的可能性。因此，在现代以太网环境中，CSMA/CD不再是必需的。
3. **全双工模式**:
   - 在交换式以太网中，设备通常以全双工模式运行，这意味着设备可以同时发送和接收数据，进一步提高了网络效率。

### MAC地址

以太网中的每个设备都有一个唯一的物理地址，称为MAC地址，用于网络通信：
1. **地址的唯一性**:
   - MAC地址是全球唯一的，这确保了网络上每个设备的标识都是独一无二的。
2. **帧寻址**:
   - 当以太网设备发送帧时，它在帧中包含目的地的MAC地址。网络上的设备检查每个经过的帧，如果帧的目的地地址与自己的MAC地址匹配，它就接收该帧，否则忽略。

通过这些机制，以太网能够有效地在多个设备之间传输数据，同时保持网络的稳定性和效率。
虽然以太网的基本原则保持不变，但随着技术的发展，其实现方式和效率已经大大提高。

----------------------------------------------------------------------------------------------------
这一现象的原因在于网络交换机的引入改变了以太网的通信方式。在早期的以太网中，多个设备共享同一媒介（如同轴电缆）进行通信，这导致了数据冲突的可能性。而在现代以太网中，使用网络交换机后，每个设备都通过独立的物理通道与交换机相连，这改变了以太网的通信动态：

### 交换机的作用
1. **独立通信通道**:
   - 在交换式以太网中，交换机为每个连接到它的设备提供了一个独立的通信通道。这意味着每个设备与交换机之间的通信是私有的，不会被网络上的其他设备“听到”。
2. **消除冲突域**:
   - 在共享媒介的网络中，当两个或更多设备同时发送数据时，会发生数据冲突，这就是所谓的冲突域。由于交换机为每个设备提供了独立的通信通道，因此每个设备的通信都是隔离的，从而实际上消除了冲突域。
3. **全双工通信**:
   - 交换机允许设备以全双工模式运行，即设备可以同时发送和接收数据。在全双工模式下，由于发送和接收是在两个独立的通道上进行，因此不会发生冲突。

### CSMA/CD的角色减弱

在这种新的网络环境中，CSMA/CD（载波侦听多路访问/冲突检测）的作用大大减少：
1. **无需侦听载波**:
   - 由于每个设备都有自己的通信通道，因此在发送数据之前不再需要检查媒介是否空闲。
2. **冲突检测不再必要**:
   - 在独立的通信通道中，设备之间不会发生冲突，因此不需要冲突检测机制。

因此，在现代以太网环境中，尤其是在使用交换机的环境中，传统的CSMA/CD机制不再是必需的。
这一改变大大提高了以太网的效率和性能，使其能够更好地适应现代网络的需求。

## 交换机的作用机制
交换机在以太网中扮演着数据转发和路由的关键角色。它通过以下几个步骤和机制来安排和管理各个设备的数据传输到更上层的设备：

### 1. MAC地址表

- **学习和存储MAC地址**:
  - 当交换机启动时，它的MAC地址表是空的。交换机通过监听来自各个端口的数据帧来“学习”设备的MAC地址。当一个数据帧从一个端口到达时，交换机记录发送该帧的设备的MAC地址，以及它所连接的端口。
- **使用MAC地址表进行转发**:
  - 当交换机需要转发一个数据帧时，它查看该帧的目的MAC地址，然后在MAC地址表中查找对应的端口。如果找到匹配的端口，交换机将帧转发到该端口。

### 2. 帧转发

- **转发和过滤决策**:
  - 交换机基于目的MAC地址决定是否转发帧。如果目的地址在MAC地址表中，帧将被转发到相应的端口；如果目的地址不在表中，帧可能会被广播到所有端口，或根据配置被丢弃。
- **广播和多播**:
  - 对于广播帧（目的地址为所有设备的特殊地址）或多播帧（目的地址为特定组的设备），交换机会将帧转发到除源端口外的所有端口。

### 3. VLAN（虚拟局域网）

- **隔离和管理流量**:
  - 交换机可以配置VLAN来隔离流量。在VLAN中，只有属于同一VLAN的设备之间可以直接通信。这允许更细粒度的网络管理和增强的安全性。

### 4. 与上层设备的连接

- **上行链路**:
  - 交换机通常有专门的端口（称为上行链路）用于连接到更高层级的网络设备，如路由器或更高级别的交换机。
- **路由选择**:
  - 对于需要发送到网络外部或上层网络设备的流量，交换机根据配置或协议将数据帧发送到上行链路。

### 5. 流量管理和QoS（服务质量）

- **优先级和带宽管理**:
  - 现代交换机可以根据服务质量（QoS）规则来管理不同类型的流量，确保重要或优先级高的流量得到适当的带宽和处理优先级。

总之，交换机通过学习和维护MAC地址表、智能地转发帧、使用VLAN进行流量隔离、连接上层设备以及实施流量管理策略，高效地组织和优化网络内的数据传输。这些功能使交换机成为现代以太网网络中不可或缺的核心设备。

## 帧
数据链路层是计算机网络OSI模型的第二层，负责在物理网络上实现*可靠的信息传输*。这一层使用的主要数据单元是“帧”（Frame）。帧是数据链路层的基本单位，用于封装从网络层传输来的数据包。帧的主要作用是确保数据包可靠地从一个网络设备传输到另一个网络设备。下面是帧的一些关键特征和组成部分：

1. **帧结构**：一个典型的帧包括帧头（Frame Header）、数据部分（Data Payload）和帧尾（Frame Trailer）。
   - **帧头**：通常包含源地址和目的地址信息，这有助于识别发送和接收设备。还可能包括错误检测和控制信息。
   - **数据部分**：这是从网络层接收的实际数据。数据链路层将这些数据封装到帧结构中。
   - **帧尾**：通常包含一种称为循环冗余检查（CRC）的错误检测代码。CRC用于检测在传输过程中帧是否受到损坏。
2. **错误控制**：数据链路层通过帧实现错误控制。通过使用CRC或其他错误检测方法，接收方可以检测到传输错误，并可以要求重发损坏的帧。
3. **流量控制**：数据链路层还负责流量控制，确保发送方不会因发送数据过快而压倒接收方。
4. **访问控制**：当多个设备共享同一个物理媒体时（如以太网），数据链路层通过MAC（媒体访问控制）协议来协调对媒体的访问。
5. **帧类型**：存在不同类型的帧，包括信息帧（用于数据传输）、监控帧（用于控制目的）和确认帧（用于确认接收）。

数据链路层的帧封装为网络通信提供了基础结构，确保数据有效且安全地在网络中传输。
====================================================================================================


一个以太网段（`Ethernet segment`）包括一些电缆（通常是双绞线）和一个叫做集线器`hub`的小盒子，
如图 11-3 所示。以太网段通常跨越一些小的区域，例如某建筑物的一个房间或者一个楼层。每根电缆都有相同的最大位带宽，通常是 100 Mb/s 或者 1 Gb/s。

一端连接到主机的适配器，而另一端则连接到集线器的一个端口上。
集线器不加分辨地将从一个端口上收到的每个位复制到其他所有的端口上。因此，每台主机都能看到每个位。

每个以太网适配器都有一个全球唯一的 48 位地址，它存储在这个适配器的非易失性存储器上。一台主机可以发送一段位（称为帧（`frame`））到这个网段内的其他任何主机。每个帧包括一些固定数量的头部（header）位，用来标识此帧的源和目的地址以及此帧的长度，此后紧随的就是数据位的有效载荷（`payload`）。每个主机适配器都能看到这个帧，但是只有目的主机实际读取它。

使用一些电缆和叫做网桥（`bridge`）的小盒子，多个以太网段可以连接成较大的局域网，称为桥接以太网（bridged Ethernet），如图 11-4 所示。桥接以太网能够跨越整个建筑物或者校区。在一个桥接以太网里，一些电缆连接网桥与网桥，而另外一些连接网桥和集线器。这些电缆的带宽可以是不同的。在我们的示例中，网桥与网桥之间的电缆有 1 Gb/s 的带宽，而四根网桥和集线器之间电缆的带宽却是 100 Mb/s。

网桥比集线器更充分地利用了电缆带宽。利用一种聪明的分配算法，它们随着时间自动学习哪个主机可以通过哪个端口可达，然后只在有必要时，有选择地将帧从一个端口复制到另一个端口。
例如，如果主机 A 发送一个帧到`同网段`上的主机 B，当该帧到达网桥 X 的输入端口时，X 就将丢弃此帧，因而节省了其他网段上的带宽。
然而，如果主机 A 发送一个帧到一个`不同网段`上的主机 C，那么网桥 X 只会把此帧复制到和网桥 Y 相连的端口上，网桥 Y 会只把此帧复制到与主机 C 的网段连接的端口。

为了简化局域网的表示，我们将把集线器和网桥以及连接它们的电缆画成一根水平线，如图 11-5 所示

在层次的更高级别中，*多个不兼容的局域网*可以通过叫做`路由器（router）`的特殊计算机连接起来，组成一个 internet（互联网络）。*每台路由器对于它所连接到的每个网络都有一个适配器（端口）*。路由器也能连接高速点到点电话连接，这是称为 WAN（Wide-Area Network，广域网）的网络示例，之所以这么叫是因为它们覆盖的地理范围比局域网的大。一般而言，路由器可以用来由各种局域网和广域网构建互联网络。例如，图 11-6 展示了一个互联网络的示例，3 台路由器连接了一对局域网和一对广域网。

> 我们总是用小写字母的 internet 描述一般概念，而用大写字母的 Internet 来描述一种具体的实现，也就是所谓的全球 IP 因特网。

⭐⭐⭐
互联网络至关重要的特性是，它能由采用`完全不同`和`不兼容技术`的各种局域网和广域网组成。每台主机和其他每台主机都是物理相连的，但是如何能够让某台源主机跨过所有这些不兼容的网络发送数据位到另一台目的主机呢？

解决办法是一层运行在每台主机和路由器上的协议软件，它消除了不同网络之间的差异。这个软件实现一种协议，这种协议控制主机和路由器如何协同工作来实现数据传输。这种协议必须提供两种基本能力：

- **命名机制**。不同的局域网技术有不同和不兼容的方式来为主机分配地址。互联网络协议通过定义一种一致的主机地址格式消除了这些差异。每台主机会被分配至少一个这种互联网络地址（internetaddress），这个地址唯一地标识了这台主机。

- **传送机制**。在电缆上编码位和将这些位封装成帧方面，不同的联网技术有不同的和不兼容的方式。互联网络协议通过定义一种把数据位捆扎成不连续的片（称为包）的统一方式，从而消除了这些差异。一个包是由包头和有效载荷组成的，其中包头包括包的大小以及源主机和目的主机的地址，有效载荷包括从源主机发出的数据位。

====================================================================================================
您描述的是互联网络协议（如互联网协议，IP），它在不同网络技术之间提供了一种统一的方式来传输数据。这种协议的关键特点在于它的命名机制和传送机制，它们是互联网的基础。下面是这些特点的详细说明：

1. **命名机制**：
   - 互联网络协议通过定义一种统一的地址格式来解决不同局域网技术间的差异。
   - 每台主机分配有一个或多个互联网络地址，通常称为IP地址。
   - 这个IP地址在整个互联网中唯一标识一台主机，确保数据可以准确地发送到正确的目的地。
   - IP地址的结构允许分层路由，使得在全球范围内的路由成为可能。

2. **传送机制**：
   - 不同的网络技术在编码和封装数据方面可能有所不同，互联网络协议通过定义统一的数据包格式来克服这些差异。
   - 数据被封装成包（或称为数据报），包括包头和有效载荷。
   - **包头**包含控制信息，如包的大小、源地址、目的地址，以及可能的错误检测和校正代码。
   - **有效载荷**包含从源主机发送出的实际数据位。
   - 这种封装方式允许数据在不同类型的网络中灵活传输，无论底层网络技术如何。

通过这些机制，互联网络协议（如IP）使得不同的网络技术能够协同工作，实现数据在复杂网络结构中的有效传输。这是现代互联网工作的基础。
====================================================================================================

这个过程有 8 个基本步骤：
 1. 运行在主机 A 上的客户端进行一个系统调用，从客户端的虚拟地址空间复制数据到内核缓冲区中。
 
 2. 主机 A 上的协议软件通过在数据前附加互联网络包头和 LAN1 帧头，创建了一个 LAN1 的帧。互联网络包头寻址到互联网络主机 B。LAN1 帧头寻址到路由器。然后它传送此帧到适配器。注意，LAN1 帧的有效载荷是一个互联网络包，而互联网络包的有效载荷是实际的用户数据。这种封装是基本的网络互联方法之一。
 
 3. LAN1 适配器复制该帧到网络上。
 
 4. 当此帧到达路由器时，路由器的 LAN1 适配器从电缆上读取它，并把它传送到协议软件。
 
 5. 路由器从互联网络包头中提取出目的互联网络地址，并用它作为路由表的索引，确定向哪里转发这个包，在本例中是 LAN2。路由器剥落旧的 LAN1 的帧头，加上寻址到主机 B 的新的 LAN2 帧头，并把得到的帧传送到适配器。
 
 6. 路由器的 LAN2 适配器复制该帧到网络上。
 
 7. 当此帧到达主机 B 时，它的适配器从电缆上读到此帧，并将它传送到协议软件。
 
 8. 最后，主机 B 上的协议软件剥落包头和帧头。当服务器进行一个读取这些数据的系统调用时，协议软件最终将得到的数据复制到服务器的虚拟地址空间。


⭐ 当然，在这里我们掩盖了许多很难的问题。如果不同的网络有不同帧大小的最大值，该怎么办呢？路由器如何知道该往哪里转发帧呢？当网络拓扑变化时，如何通知路由器？如果一个包丢失了又会如何呢？虽然如此，我们的示例抓住了互联网络思想的精髓，封装是关键。 [这些内容就需要计算机网络内容里详细补充力]

